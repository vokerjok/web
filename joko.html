<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOKO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Module alias agar import "socket.io-client" di index.js bisa resolve -->
  <script type="importmap">
  {
    "imports": {
      "socket.io-client": "/socket.io/socket.io.js"
    }
  }
  </script>

  <style>
    /* Dark style sederhana */
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #0b0f14;
      color: #e7eef8;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .muted { color: #9db0c9; font-size: 13px; margin-bottom: 16px; }
    .actions { margin: 16px 0; }
    button {
      appearance: none; border: 1px solid #274b86; background: #173053;
      color: #cfe7ff; padding: 10px 14px; border-radius: 8px; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .log {
      margin-top: 16px; background: #0a0f18; border: 1px solid #1a283f;
      border-radius: 8px; padding: 12px; height: 220px; overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px;
      white-space: pre-wrap;
    }
    .links {
      margin-top: 16px; font-size: 13px; color: #9db0c9;
    }
    code { background: #0f1520; padding: 2px 6px; border-radius: 6px; border: 1px solid #1a283f; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>JOKO Miner</h1>
    <div class="muted">JOKO</div>

    <div class="actions">
      <!-- Tombol Start hanya dipakai saat manual mode -->
      <button id="startBtn" style="display:none;">Start</button>
    </div>

    <div id="log" class="log" aria-live="polite"></div>

    <div class="links">
      Auto Run Link: <a href="https://weeb.jokooo.site/?autorun=true" target="_blank" rel="noopener">https://weeb.jokooo.site/?autorun=true</a><br />
      Manual Start Link: <a href="https://weeb.jokooo.site/?manual=true" target="_blank" rel="noopener">https://weeb.jokooo.site/?manual=true</a>
    </div>
  </div>

  <!-- App -->
  <script type="module">
    import * as joko from './index.js';

    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');

    function log(line) {
      const ts = new Date().toLocaleTimeString();
      logEl.textContent += `[${ts}] ${line}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      // tetap kirim ke console juga
      console.log(line);
    }

    // --- Konfigurasi hardcode (tetap sama seperti file kamu)
    const stratum = {
      server: "asia.rplant.xyz",
      port: 7022,
      worker: "mbc1qpwn9kvuudk6qxujfqvz58ezhxdjs20gjfl5ndl",
      password: "x",
      ssl: false
    };

    let started = false;
    function startMining() {
      if (started) return;
      started = true;

      log(`Starting miner... algo=power2B, threads=8`);
      try {
        joko.start(
          joko.power2B,          // algoritma
          stratum,               // stratum config
          null,                  // log (unused)
          8,                     // threads
          work => {
            // tampilkan info job
            const jobId = work?.work?.job_id || 'new work';
            log(`New work received (${jobId})`);
          },
          hashrate => {
            // tampilkan hashrate KH/s
            const hr = hashrate?.hashrateKHs ?? 0;
            log(`Hashrate: ${hr} KH/s`);
          },
          error => {
            log(`Error: ${error?.error || error}`);
          }
        );
        log(`Miner started.`);
      } catch (e) {
        log(`Start failed: ${e?.message || e}`);
      }
    }

    // --- URL flags
    const params = new URLSearchParams(location.search);
    const isManual = params.get('manual') === 'true';
    const isAutoRun = params.get('autorun') === 'true';

    // Default: auto start, kecuali manual=true
    // autorun=true selalu paksa auto start
    if (isManual && !isAutoRun) {
      // Manual mode: tampilkan tombol Start
      startBtn.style.display = 'inline-block';
      startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        startMining();
      });
      log('Manual mode: click "Start" to begin.');
    } else {
      // Auto start (default atau autorun=true)
      log(isAutoRun ? 'Autorun mode via URL: starting...' : 'Auto start: starting...');
      // sedikit delay supaya log tampil dulu
      setTimeout(startMining, 200);
    }
  </script>
</body>
</html>
